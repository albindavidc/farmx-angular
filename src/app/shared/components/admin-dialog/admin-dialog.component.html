<div
  class="dialog-container"
  role="dialog"
  [attr.aria-labelledby]="'dialog-title'"
>
  <h2 mat-dialog-title id="dialog-title" class="dialog-title">
    <mat-icon class="title-icon" aria-hidden="true">
      {{ data.mode === "create" ? "add_circle" : "edit" }}
    </mat-icon>
    {{ dialogTitle }}
  </h2>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
    <mat-dialog-content class="dialog-content">
      <div
        class="form-fields"
        role="group"
        aria-label="Community information form"
      >
        <!-- Community Name Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Community Name</mat-label>
          <input
            matInput
            formControlName="name"
            placeholder="Enter community name"
            maxlength="100"
            autocomplete="off"
          />
          <mat-icon matPrefix aria-hidden="true">community</mat-icon>
          <mat-hint align="end"
            >{{ nameControl?.value?.length || 0 }}/100</mat-hint
          >
          <mat-error role="alert">{{ getNameErrorMessage() }}</mat-error>
        </mat-form-field>

        <!-- Description Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea
            matInput
            formControlName="description"
            placeholder="Enter community description"
            rows="4"
            maxlength="500"
            autocomplete="off"
          ></textarea>
          <mat-icon matPrefix aria-hidden="true">description</mat-icon>
          <mat-hint align="end"
            >{{ descriptionControl?.value?.length || 0 }}/500</mat-hint
          >
          <mat-error role="alert">{{ getDescriptionErrorMessage() }}</mat-error>
        </mat-form-field>

        <!-- Categories Section -->
        <div class="categories-section">
          <label class="section-label">
            <mat-icon aria-hidden="true">label</mat-icon>
            Categories
            <span class="optional-label">(Optional)</span>
          </label>

          <div class="category-input-wrapper">
            <mat-form-field appearance="outline" class="category-input">
              <mat-label>Add Category</mat-label>
              <input
                matInput
                formControlName="categoryInput"
                placeholder="e.g., Agriculture, Technology"
                (keyup.enter)="addCategory()"
                autocomplete="off"
              />
              <mat-icon matPrefix aria-hidden="true">add</mat-icon>
            </mat-form-field>
            <button
              mat-mini-fab
              color="primary"
              type="button"
              (click)="addCategory()"
              [disabled]="!categoryInputControl?.value?.trim()"
              aria-label="Add category"
            >
              <mat-icon>add</mat-icon>
            </button>
          </div>

          <div class="categories-list" *ngIf="categories.length > 0">
            <mat-chip-listbox aria-label="Selected categories">
              <mat-chip-option
                *ngFor="let category of categories"
                [removable]="true"
                (removed)="removeCategory(category)"
              >
                {{ category }}
                <mat-icon matChipRemove>cancel</mat-icon>
              </mat-chip-option>
            </mat-chip-listbox>
          </div>
        </div>

        <!-- Image Upload Section -->
        <div class="image-upload-section">
          <label class="section-label">
            <mat-icon aria-hidden="true">image</mat-icon>
            Community Image
            <span class="optional-label">(Optional)</span>
          </label>

          <div class="filepond-wrapper">
            <file-pond
              #filePond
              [options]="pondOptions"
              [files]="pondFiles"
              (oninit)="pondHandleInit()"
              (onaddfile)="pondHandleAddFile()"
              (onprocessfile)="pondHandleProcessFile($event)"
              (onremovefile)="pondHandleRemoveFile()"
              (onerror)="pondHandleError()"
            ></file-pond>

            <div class="upload-progress" *ngIf="isUploadingImage">
              <mat-spinner diameter="24"></mat-spinner>
              <span>Uploading image...</span>
            </div>
          </div>

          <div class="url-input-divider">
            <span>OR</span>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Image URL</mat-label>
            <input
              matInput
              formControlName="imageUrl"
              placeholder="https://example.com/image.jpg"
              type="url"
            />
            <mat-icon matPrefix aria-hidden="true">link</mat-icon>
          </mat-form-field>

          <div
            class="image-preview"
            *ngIf="uploadedImageUrl || form.get('imageUrl')?.value"
          >
            <p class="preview-label">Preview:</p>
            <img
              [src]="uploadedImageUrl || form.get('imageUrl')?.value"
              alt="Community image preview"
              (error)="onImageError($event)"
            />
          </div>
        </div>

        <!-- Active Status Checkbox -->
        <div class="checkbox-field">
          <mat-checkbox formControlName="isActive" color="primary">
            <span class="checkbox-label">
              <mat-icon aria-hidden="true">check_circle</mat-icon>
              Active Community
            </span>
          </mat-checkbox>
          <p class="checkbox-hint">
            Inactive communities will not be visible to users
          </p>
        </div>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end" class="dialog-actions">
      <button
        mat-button
        type="button"
        (click)="onCancel()"
        [disabled]="isSubmitting"
        aria-label="Cancel"
      >
        <mat-icon aria-hidden="true">close</mat-icon>
        Cancel
      </button>
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="form.invalid || isSubmitting || isUploadingImage"
        class="submit-button"
      >
        <mat-icon aria-hidden="true" *ngIf="!isSubmitting">
          {{ data.mode === "create" ? "add" : "save" }}
        </mat-icon>
        <mat-spinner *ngIf="isSubmitting" diameter="20"></mat-spinner>
        <span *ngIf="!isSubmitting">
          {{ data.mode === "create" ? "Create" : "Update" }}
        </span>
        <span *ngIf="isSubmitting">Processing...</span>
      </button>
    </mat-dialog-actions>
  </form>
</div>
