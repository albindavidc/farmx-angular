<div
  class="dialog-container"
  role="dialog"
  [attr.aria-labelledby]="'dialog-title'"
>
  <h2 mat-dialog-title id="dialog-title" class="dialog-title">
    <mat-icon class="title-icon" aria-hidden="true">
      {{ data.mode === "create" ? "add_circle" : "edit" }}
    </mat-icon>
    {{ dialogTitle }}
  </h2>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" novalidate>
    <mat-dialog-content class="dialog-content">
      <div
        class="form-fields"
        role="group"
        aria-label="Community information form"
      >
        <!-- Community Name Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Community Name</mat-label>
          <input
            matInput
            formControlName="name"
            placeholder="Enter community name"
            [attr.aria-label]="getAriaLabel('name')"
            [attr.aria-invalid]="nameControl?.invalid && nameControl?.touched"
            [attr.aria-describedby]="
              nameControl?.invalid && nameControl?.touched ? 'name-error' : null
            "
            maxlength="100"
            autocomplete="off"
          />
          <mat-icon matPrefix aria-hidden="true">community</mat-icon>
          <mat-hint align="end"
            >{{ nameControl?.value?.length || 0 }}/100</mat-hint
          >
          <mat-error id="name-error" role="alert">
            {{ getNameErrorMessage() }}
          </mat-error>
        </mat-form-field>

        <!-- Description Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea
            matInput
            formControlName="description"
            placeholder="Enter community description"
            rows="4"
            [attr.aria-label]="getAriaLabel('description')"
            [attr.aria-invalid]="
              descriptionControl?.invalid && descriptionControl?.touched
            "
            [attr.aria-describedby]="
              descriptionControl?.invalid && descriptionControl?.touched
                ? 'description-error'
                : null
            "
            maxlength="500"
            autocomplete="off"
          ></textarea>
          <mat-icon matPrefix aria-hidden="true">description</mat-icon>
          <mat-hint align="end"
            >{{ descriptionControl?.value?.length || 0 }}/500</mat-hint
          >
          <mat-error id="description-error" role="alert">
            {{ getDescriptionErrorMessage() }}
          </mat-error>
        </mat-form-field>

        <!-- Member Count and Creation Date Row -->
        <div class="form-row">
          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Member Count</mat-label>
            <input
              matInput
              type="number"
              formControlName="memberCount"
              min="0"
              max="1000000"
              [attr.aria-label]="getAriaLabel('memberCount')"
              [attr.aria-invalid]="
                memberCountControl?.invalid && memberCountControl?.touched
              "
              [attr.aria-describedby]="
                memberCountControl?.invalid && memberCountControl?.touched
                  ? 'member-count-error'
                  : null
              "
            />
            <mat-icon matPrefix aria-hidden="true">people</mat-icon>
            <mat-error id="member-count-error" role="alert">
              {{ getMemberCountErrorMessage() }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="form-field-half">
            <mat-label>Creation Date</mat-label>
            <input
              matInput
              [matDatepicker]="picker"
              formControlName="creationDate"
              [max]="maxDate"
              readonly
              [attr.aria-label]="getAriaLabel('creationDate')"
              [attr.aria-invalid]="
                creationDateControl?.invalid && creationDateControl?.touched
              "
              [attr.aria-describedby]="
                creationDateControl?.invalid && creationDateControl?.touched
                  ? 'creation-date-error'
                  : null
              "
            />
            <mat-icon matPrefix aria-hidden="true">event</mat-icon>
            <mat-datepicker-toggle
              matSuffix
              [for]="picker"
              [attr.aria-label]="'Open calendar to select creation date'"
            ></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error id="creation-date-error" role="alert">
              {{ getCreationDateErrorMessage() }}
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Image Upload Section -->
        <div class="image-upload-section">
          <label class="section-label">
            <mat-icon aria-hidden="true">image</mat-icon>
            Community Image
            <span class="optional-label">(Optional)</span>
          </label>

          <div class="filepond-wrapper">
            <file-pond
              #filePond
              [options]="pondOptions"
              [files]="pondFiles"
              (oninit)="pondHandleInit()"
              (onaddfile)="pondHandleAddFile($event)"
              (onprocessfile)="pondHandleProcessFile($event)"
              (onremovefile)="pondHandleRemoveFile($event)"
              (onerror)="pondHandleError($event)"
              [attr.aria-label]="'Upload community image'"
            ></file-pond>

            <!-- Upload Progress Indicator -->
            <div class="upload-progress" *ngIf="isUploadingImage">
              <mat-spinner diameter="24"></mat-spinner>
              <span>Uploading image...</span>
            </div>
          </div>

          <!-- Manual Image URL Input (Alternative) -->
          <div class="url-input-divider">
            <span>OR</span>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Image URL</mat-label>
            <input
              matInput
              formControlName="image"
              placeholder="https://example.com/image.jpg"
              [attr.aria-label]="getAriaLabel('image')"
              [attr.aria-invalid]="
                imageControl?.invalid && imageControl?.touched
              "
              [attr.aria-describedby]="
                imageControl?.invalid && imageControl?.touched
                  ? 'image-error'
                  : null
              "
              type="url"
            />
            <mat-icon matPrefix aria-hidden="true">link</mat-icon>
            <mat-icon
              matSuffix
              class="info-icon"
              [matTooltip]="'Provide a direct URL to an image'"
              matTooltipPosition="above"
              aria-label="Image URL help"
            >
              info
            </mat-icon>
            <mat-error id="image-error" role="alert">
              {{ getImageErrorMessage() }}
            </mat-error>
          </mat-form-field>

          <!-- Image Preview -->
          <div
            class="image-preview"
            *ngIf="uploadedImageUrl || form.get('image')?.value"
          >
            <p class="preview-label">Preview:</p>
            <img
              [src]="uploadedImageUrl || form.get('image')?.value"
              alt="Community image preview"
              (error)="onImageError($event)"
            />
          </div>
        </div>

        <!-- Active Status Checkbox -->
        <div class="checkbox-field">
          <mat-checkbox
            formControlName="isActive"
            [attr.aria-label]="getAriaLabel('isActive')"
            color="primary"
          >
            <span class="checkbox-label">
              <mat-icon aria-hidden="true">check_circle</mat-icon>
              Active Community
            </span>
          </mat-checkbox>
          <p class="checkbox-hint">
            Inactive communities will not be visible to users
          </p>
        </div>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions align="end" class="dialog-actions">
      <button
        mat-button
        type="button"
        (click)="onCancel()"
        [disabled]="isSubmitting"
        aria-label="Cancel and close dialog"
      >
        <mat-icon aria-hidden="true">close</mat-icon>
        Cancel
      </button>
      <button
        mat-raised-button
        color="primary"
        type="submit"
        [disabled]="form.invalid || isSubmitting || isUploadingImage"
        [attr.aria-label]="
          data.mode === 'create' ? 'Create new community' : 'Update community'
        "
        class="submit-button"
      >
        <mat-icon aria-hidden="true" *ngIf="!isSubmitting">
          {{ data.mode === "create" ? "add" : "save" }}
        </mat-icon>
        <mat-spinner
          *ngIf="isSubmitting"
          diameter="20"
          aria-label="Submitting form"
        ></mat-spinner>
        <span *ngIf="!isSubmitting">
          {{ data.mode === "create" ? "Create" : "Update" }}
        </span>
        <span *ngIf="isSubmitting">Processing...</span>
      </button>
    </mat-dialog-actions>
  </form>
</div>
